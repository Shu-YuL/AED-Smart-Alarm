var sheet_id = "1vdIEF1UmQx2RttqbzoxveTfbGcOXLkPOXro1gw-HovA";
var ss = SpreadsheetApp.openById(sheet_id);
var paired_sheet = ss.getSheetByName("Paired_devices");
var triggered_sheet = ss.getSheetByName("Triggered_devices");
var log_sheet = ss.getSheetByName("Event_Log");

const recipient_emails = "user1@domain.com" + "," + "user2@domain.com";

/* function that deal with HTTP POST requests (from Monitoring devices) */
function doPost(e)
{
  var pairedLastRow = paired_sheet.getLastRow();
  var triggeredLastRow = triggered_sheet.getLastRow();

  /* retrieves data from HTTP POST request */
  var MAC = String(e.parameter.MAC);
  var IP = String(e.parameter.IP);
  /* get current date and time */
  var date = new Date();

  var Match_flag = 0;

  /* search for a matching MAC in the "Paired_devices" sheet. */ 
  for (var i = 2; i <= pairedLastRow; i++) 
  {
    /* If a match is found, it retrieves the corresponding location from the paired sheet and saves it to the triggered sheet */ 
    if (paired_sheet.getRange(i, 1).getValue() == MAC) 
    {
      location = paired_sheet.getRange(i, 2).getValue();
      Match_flag = 1; // flag indicates a match is found
      break;
    }
  }

  /* If Match flag set */
  if (Match_flag)
  {
    /* append new row */
    triggered_sheet.appendRow([MAC,IP,location]);
    log_sheet.appendRow([MAC,IP,location,date]);

    /* --------- Send Email ----------- */
    
  MailApp.sendEmail({
    to: recipient_emails,
    cc: "",
    subject: "AED Alarm Alert",
    body: `Alarm Triggered \n\nLocation: ${location} \nTime: ${date} \nDevice IP: ${IP} \nDevice MAC: ${MAC}` //note the back-ticks ` ; they are not single quotation marks
  })



  }
  /* If no match, add the MAC to a new row in the "Paired_devices" sheet (Pairing a new device) */
  else
  {
    paired_sheet.appendRow([MAC]);
  }
}

/* function that deal with HTTP GET requests (from Base station) */
function doGet(e)
{
  var read = e.parameter.read; // set key value = "read" to read data from the Google sheet
  var clear = e.parameter.clear;
  if (read !== undefined)
  {
    return ContentService.createTextOutput(triggered_sheet.getRange('C2').getValue());
  }
  else if (clear !== undefined)
  {
    triggered_sheet.deleteRow(2);  // if Clear button is pressed, delete row 2
  }
}
